<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Warface Preset Generator (JSON)</title>
  <style>
    /* 1) Оформление в 2 колонки */
    .layout-container {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }
    .left-panel {
      width: 500px;
      min-width: 350px;
    }
    .search-box {
      margin-bottom: 8px;
    }
    .weapon-list-container {
      max-height: 450px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 8px;
    }
    .weapon-list ul {
      margin: 0; padding: 0; list-style-type: none;
    }
    .weapon-list li {
      margin: 4px 0;
      cursor: pointer;
    }
    .weapon-list li:hover {
      background: #f8f8f8;
    }
    .pagination-controls {
      text-align: center;
      margin-bottom: 16px;
    }
    .pagination-controls button {
      margin: 0 8px;
    }
    /* 2) Правая колонка */
    .right-panel {
      width: 400px;
    }
    .selected-weapons {
      margin-bottom: 16px;
    }
    .selectedWeaponItem {
      border: 1px solid #ccc;
      padding: 8px;
      margin: 8px 0;
      background: #fafafa;
    }
    .selectedWeaponItem:hover {
      background: #f2f2f2;
    }
    textarea {
      width: 100%;
      height: 300px;
    }
    .appearance-block {
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
<h1>Warface Preset Generator (JSON, всё в одном)</h1>

<div class="layout-container">
  <!-- Левая колонка: поиск, список, пагинация -->
  <div class="left-panel">
    <div class="search-box">
      <label for="searchInput">Поиск оружия:</label><br>
      <input type="text" id="searchInput" placeholder="Введите название" style="width:100%;">
    </div>
    <div class="weapon-list-container">
      <div class="weapon-list">
        <ul id="weaponsUl"></ul>
      </div>
    </div>
    <div class="pagination-controls">
      <button id="prevPageBtn">« Предыдущая</button>
      <span id="pageInfo"></span>
      <button id="nextPageBtn">Следующая »</button>
    </div>
  </div>

  <!-- Правая колонка: внешность, выбранные предметы, генерация -->
  <div class="right-panel">
    <div class="appearance-block">
      <h3>Выбор внешности</h3>
      <select id="appearanceSelect">
        <!-- наполним при загрузке -->
      </select>
    </div>

    <div class="selected-weapons">
      <h3>Выбранные предметы</h3>
      <div id="selectedContainer"></div>
    </div>

    <button id="generateBtn">Сгенерировать пресет</button>

    <h3>Результат:</h3>
    <textarea id="resultArea" readonly></textarea><br>
    <button id="downloadBtn">Скачать</button>
  </div>
</div>


<script>
// ************************************************************
// Глобальные переменные
// ************************************************************
let weaponsData = [];      // из all_weapons.json
let skinsData = [];        // из all_skins.json
let localizationMap = {};  // из items.txt (при желании)

let filteredWeapons = [];
let selectedWeapons = [];
let selectedAppearance = '';

let currentPage = 1;
const itemsPerPage = 20;

// ************************************************************
// При загрузке страницы
// ************************************************************
window.addEventListener('load', async () => {
  try {
    // (1) Локализация (необязательно)
    await loadLocalization('data/items.txt');

    // (2) Оружие
    const wResp = await fetch('data/all_weapons.json');
    weaponsData = await wResp.json();

    // (3) Внешности
    const sResp = await fetch('data/all_skins.json');
    if (sResp.ok) {
      skinsData = await sResp.json();
    }

    // (4) Заполняем селект внешностей
    populateAppearanceSelect();

    // (5) Готовим список оружий к отображению
    filteredWeapons = [...weaponsData];
    currentPage = 1;
    renderWeaponList();
  } catch (err) {
    console.error('Ошибка при загрузке данных:', err);
  }
});

// ************************************************************
// 1) Загрузка локализации (если нужно)
// ************************************************************
async function loadLocalization(path) {
  try {
    const resp = await fetch(path);
    if (!resp.ok) {
      console.warn('Не нашёл локализацию:', path);
      return;
    }
    const textData = await resp.text();
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(textData, 'text/xml');
    const itemsRoot = xmlDoc.getElementsByTagName('Items')[0];
    if (!itemsRoot) {
      console.warn('Нет <Items> в файле локализации');
      return;
    }
    const itemNodes = itemsRoot.getElementsByTagName('Item');
    for (let i=0; i<itemNodes.length; i++) {
      const el = itemNodes[i];
      const name = el.getAttribute('name');
      const locName = el.getAttribute('item_name') || name;
      localizationMap[name] = locName;

      // skins
      const skinsEls = el.getElementsByTagName('skins');
      if (skinsEls.length>0) {
        const skinEls = skinsEls[0].getElementsByTagName('skin');
        for (let j=0; j<skinEls.length; j++) {
          const sEl = skinEls[j];
          const sName = sEl.getAttribute('name');
          const sLoc = sEl.getAttribute('skin_name') || sName;
          localizationMap[sName] = sLoc;
        }
      }
      // attachments
      const attEls = el.getElementsByTagName('attachments');
      if (attEls.length>0) {
        const aEls = attEls[0].getElementsByTagName('attachment');
        for (let j=0; j<aEls.length; j++) {
          const aEl = aEls[j];
          const aName = aEl.getAttribute('name');
          const aLoc = aEl.getAttribute('attachment_name') || aName;
          localizationMap[aName] = aLoc;
        }
      }
    }
    console.log('Localization loaded:', localizationMap);
  } catch (err) {
    console.warn('Ошибка loadLocalization:', err);
  }
}

// ************************************************************
// 2) populateAppearanceSelect
// ************************************************************
function populateAppearanceSelect() {
  const sel = document.getElementById('appearanceSelect');
  sel.innerHTML = '';

  // Опция «Без внешности»
  const noneOpt = document.createElement('option');
  noneOpt.value = '';
  noneOpt.textContent = 'Без внешности';
  sel.appendChild(noneOpt);

  skinsData.forEach(skin => {
    // skin.name = "soldier_fbs_samurai01", например
    const opt = document.createElement('option');
    opt.value = skin.name;
    const locName = localizationMap[skin.name] || skin.name;
    opt.textContent = locName;
    sel.appendChild(opt);
  });

  sel.value = '';
  selectedAppearance = '';
  sel.addEventListener('change', () => {
    selectedAppearance = sel.value; 
  });
}

// ************************************************************
// 3) Поиск «на лету»
// ************************************************************
document.getElementById('searchInput').addEventListener('input', () => {
  const query = document.getElementById('searchInput').value.toLowerCase();
  filteredWeapons = weaponsData.filter(w => {
    const locName = localizationMap[w.name] || w.name;
    return (
      w.name.toLowerCase().includes(query) ||
      (w.category || '').toLowerCase().includes(query) ||
      locName.toLowerCase().includes(query)
    );
  });
  currentPage = 1;
  renderWeaponList();
});

// ************************************************************
// 4) Рендер списка оружий (пагинация)
// ************************************************************
function renderWeaponList() {
  const ul = document.getElementById('weaponsUl');
  ul.innerHTML = '';

  const startIndex = (currentPage - 1)*itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageItems = filteredWeapons.slice(startIndex, endIndex);

  pageItems.forEach(w => {
    const li = document.createElement('li');
    const locName = localizationMap[w.name] || w.name;
    li.textContent = `${locName} (${w.name})`;
    li.onclick = () => addSelectedWeapon(w);
    ul.appendChild(li);
  });

  const totalPages = Math.ceil(filteredWeapons.length / itemsPerPage);
  document.getElementById('pageInfo').textContent = `Стр. ${currentPage} из ${totalPages}`;
}

document.getElementById('prevPageBtn').addEventListener('click', () => {
  if (currentPage>1) {
    currentPage--;
    renderWeaponList();
  }
});
document.getElementById('nextPageBtn').addEventListener('click', () => {
  const totalPages = Math.ceil(filteredWeapons.length / itemsPerPage);
  if (currentPage<totalPages) {
    currentPage++;
    renderWeaponList();
  }
});

// ************************************************************
// 5) Добавить предмет
// ************************************************************
function addSelectedWeapon(w) {
  // Создаём объект для выбора
  const newItem = {
    originalName: w.name,
    localizedName: localizationMap[w.name] || w.name,
    ammoType: w.ammoType,
    attachments: (w.attachments||[]).map(a => ({
      id: a,
      localizedName: localizationMap[a] || a
    })),
    skins: (w.skins||[]).map(s => ({
      id: s,
      localizedName: localizationMap[s] || s
    })),
    selectedSkinId: ''
  };
  selectedWeapons.push(newItem);
  renderSelectedWeapons();
}

// ************************************************************
// 6) Отрисовать выбранные предметы
// ************************************************************
function renderSelectedWeapons() {
  const container = document.getElementById('selectedContainer');
  container.innerHTML = '';

  selectedWeapons.forEach((sw, index) => {
    const div = document.createElement('div');
    div.className = 'selectedWeaponItem';

    // Название
    const title = document.createElement('div');
    title.innerHTML = `<strong>${sw.localizedName}</strong>`;
    div.appendChild(title);

    // Выбор скина (для оружия)
    if (sw.skins && sw.skins.length>0) {
      const label = document.createElement('label');
      label.textContent = 'Скин: ';
      const sel = document.createElement('select');

      // «Без скина»
      const noneOpt = document.createElement('option');
      noneOpt.value = '';
      noneOpt.textContent = 'Без скина';
      sel.appendChild(noneOpt);

      sw.skins.forEach(sObj => {
        const opt = document.createElement('option');
        opt.value = sObj.id;
        opt.textContent = sObj.localizedName;
        sel.appendChild(opt);
      });

      sel.value = sw.selectedSkinId;
      sel.onchange = (e) => {
        sw.selectedSkinId = e.target.value;
      };
      label.appendChild(sel);
      div.appendChild(document.createElement('br'));
      div.appendChild(label);
    }

    // Кнопка удалить
    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Удалить';
    removeBtn.style.marginLeft = '16px';
    removeBtn.onclick = () => {
      selectedWeapons.splice(index, 1);
      renderSelectedWeapons();
    };
    div.appendChild(removeBtn);

    container.appendChild(div);
  });
}

// ************************************************************
// 7) Сгенерировать Lua
// ************************************************************
document.getElementById('generateBtn').addEventListener('click', () => {
  const script = generatePresetLua();
  document.getElementById('resultArea').value = script;
});

function generatePresetLua() {
  // Внешность
  const appearanceLine = selectedAppearance ? `{ name = "${selectedAppearance}" },` : '';

  const armorBlock = `
  armor = 
  {
    ${appearanceLine}
  },`;

  // Items
  let itemsStr = `  items = {\n`;
  selectedWeapons.forEach(sw => {
    itemsStr += `    { name = "${sw.originalName}", skin = "${sw.selectedSkinId}" },\n`;
  });
  itemsStr += `  },`;

  // Attachments
  let attachmentsStr = `  attachments = {\n`;
  selectedWeapons.forEach(sw => {
    (sw.attachments||[]).forEach(a => {
      attachmentsStr += `    { name = "${a.id}", attachTo = "${sw.originalName}" },\n`;
    });
  });
  attachmentsStr += `  },`;

  // Ammo
  let ammoStr = `  ammo = {\n`;
  selectedWeapons.forEach(sw => {
    if (sw.ammoType) {
      ammoStr += `    { name = "${sw.ammoType}", amount = 999 },\n`;
    }
  });
  ammoStr += `  },`;

  return `
local inventory = {
${armorBlock}
${itemsStr}
${attachmentsStr}
${ammoStr}
}
return inventory
`.trim();
}

// ************************************************************
// 8) Скачать результат
// ************************************************************
document.getElementById('downloadBtn').addEventListener('click', () => {
  const text = document.getElementById('resultArea').value;
  const blob = new Blob([text], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'warface_preset.lua';
  link.click();
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
