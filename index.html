<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Warface Preset Generator (Client-side)</title>
  <style>
    /* Обёртка, чтобы сделать 2 колонки */
    .layout-container {
      display: flex;
      gap: 16px;
      align-items: flex-start; /* верхняя граница совмещена */
    }

    /* Левая колонка (список + пагинация) */
    .left-panel {
      width: 500px;
      min-width: 350px;
    }
    .search-box {
      margin-bottom: 8px;
    }
    .weapon-list-container {
      max-height: 450px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 8px;
    }
    .weapon-list ul {
      margin: 0;
      padding: 0;
      list-style-type: none;
    }
    .weapon-list li {
      margin: 4px 0;
      cursor: pointer;
    }
    .weapon-list li:hover {
      background: #f8f8f8;
    }
    .pagination-controls {
      text-align: center;
      margin-bottom: 16px;
    }
    .pagination-controls button {
      margin: 0 8px;
    }

    /* Правая колонка (выбранные и результат) */
    .right-panel {
      width: 400px;
    }
    .selected-weapons {
      margin-bottom: 16px;
    }
    .selectedWeaponItem {
      border: 1px solid #ccc;
      padding: 8px;
      margin: 8px 0;
      background: #fafafa;
    }
    .selectedWeaponItem:hover {
      background: #f2f2f2;
    }

    textarea {
      width: 100%;
      height: 300px;
    }

    /* Доп. стили для выбора внешности */
    .appearance-block {
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
<h1>Warface Preset Generator (Client-side)</h1>

<div class="layout-container">
  <!-- Левая колонка: поиск + список + пагинация -->
  <div class="left-panel">
    <div class="search-box">
      <label for="searchInput">Поиск оружия:</label><br/>
      <input type="text" id="searchInput" placeholder="Введите название" style="width: 100%;" />
    </div>

    <div class="weapon-list-container">
      <div class="weapon-list">
        <ul id="weaponsUl"></ul>
      </div>
    </div>

    <div class="pagination-controls">
      <button id="prevPageBtn">« Предыдущая</button>
      <span id="pageInfo"></span>
      <button id="nextPageBtn">Следующая »</button>
    </div>
  </div>

  <!-- Правая колонка: выбранные + внешний вид + генерация -->
  <div class="right-panel">
    <!-- Добавим блок выбора внешности -->
    <div class="appearance-block">
      <h3>Выбор внешности</h3>
      <select id="appearanceSelect">
        <!-- Заполним вариантами из skinsData -->
      </select>
    </div>

    <div class="selected-weapons">
      <h3>Выбранные предметы</h3>
      <div id="selectedContainer"></div>
    </div>

    <button id="generateBtn">Сгенерировать пресет</button>

    <h3>Результат:</h3>
    <textarea id="resultArea" readonly></textarea><br/>
    <button id="downloadBtn">Скачать</button>
  </div>
</div>


<script>
/*************************************************************
 * Глобальные переменные (как раньше в Node, но теперь в браузере)
 *************************************************************/
let weaponsData = [];      // сюда загрузим все оружия (xml -> JS)
let skinsData = [];        // сюда загрузим все внешности (xml -> JS)
let localizationMap = {};  // общий словарь локализаций (из items.txt/xml)

let filteredWeapons = [];  // отфильтрованный список по поиску
let selectedWeapons = [];  // выбранные предметы
let selectedAppearance = ''; // выбранная внешность

// Пагинация
let currentPage = 1;
const itemsPerPage = 20; // по 20 штук на странице

/*************************************************************
 * 1) При загрузке страницы:
 *    - грузим локализации (items.txt)
 *    - грузим список файлов оружия из weapons_manifest.json, парсим все
 *    - грузим список файлов внешностей из skins_manifest.json, парсим все
 *    - затем рендерим
 *************************************************************/
window.addEventListener('load', async () => {
  // 1. Загрузка локализаций
  await loadLocalization('data/items.txt'); // или 'data/items.xml'

  // 2. Загружаем weapon-XML-файлы (через manifest)
  weaponsData = await loadAllWeapons('data/weapons_manifest.json');

  // 3. Загружаем skin-XML-файлы (через manifest)
  skinsData = await loadAllSkins('data/skins_manifest.json');

  // Заполняем выпадающий список внешностей
  populateAppearanceSelect();

  // Инициализируем список оружия (поиск + пагинация)
  filteredWeapons = [...weaponsData];
  currentPage = 1;
  renderWeaponList();
});

/*************************************************************
 * 2) Загрузка локализаций (items.txt/xml)
 *    - Пример простого XML парсинга средствами DOMParser
 *************************************************************/
async function loadLocalization(filePath) {
  try {
    const response = await fetch(filePath);
    const textData = await response.text();

    // Парсим как XML
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(textData, 'text/xml');

    // Вдруг нет корневого элемента <Items> — проверим
    const itemsRoot = xmlDoc.getElementsByTagName('Items')[0];
    if (!itemsRoot) {
      console.warn('No <Items> root in localization file.');
      return;
    }

    // Пробегаемся по <Item>
    const itemNodes = itemsRoot.getElementsByTagName('Item');
    for (let i = 0; i < itemNodes.length; i++) {
      const itemEl = itemNodes[i];
      const name = itemEl.getAttribute('name');
      const localizedName = itemEl.getAttribute('item_name') || name;
      localizationMap[name] = localizedName;

      // skins
      const skinsEls = itemEl.getElementsByTagName('skins');
      if (skinsEls.length > 0) {
        const skinEls = skinsEls[0].getElementsByTagName('skin');
        for (let j = 0; j < skinEls.length; j++) {
          const sEl = skinEls[j];
          const sName = sEl.getAttribute('name');
          const sLocalized = sEl.getAttribute('skin_name') || sName;
          localizationMap[sName] = sLocalized;
        }
      }

      // attachments
      const attEls = itemEl.getElementsByTagName('attachments');
      if (attEls.length > 0) {
        const aEls = attEls[0].getElementsByTagName('attachment');
        for (let j = 0; j < aEls.length; j++) {
          const aEl = aEls[j];
          const aName = aEl.getAttribute('name');
          const aLocalized = aEl.getAttribute('attachment_name') || aName;
          localizationMap[aName] = aLocalized;
        }
      }
    }

    console.log('Localization loaded:', localizationMap);
  } catch (err) {
    console.error('Error loading localization:', err);
  }
}

/*************************************************************
 * 3) Загрузка и парсинг ВСЕХ weapon-XML из weapons_manifest.json
 *************************************************************/
async function loadAllWeapons(manifestPath) {
  const result = [];

  try {
    // 1) Скачиваем список файлов из манифеста
    const manifestRes = await fetch(manifestPath);
    const manifestList = await manifestRes.json();

    // 2) Для каждого пути — грузим XML и парсим
    for (const xmlFilePath of manifestList) {
      const weaponObj = await parseWeaponXML(xmlFilePath);
      if (weaponObj) {
        result.push(weaponObj);
      }
    }
  } catch (err) {
    console.error('Error loading weapons:', err);
  }

  return result;
}

/*************************************************************
 * parseWeaponXML: парсим один weapon.xml
 *************************************************************/
async function parseWeaponXML(xmlFilePath) {
  try {
    const res = await fetch(xmlFilePath);
    const xmlText = await res.text();

    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

    const itemEl = xmlDoc.getElementsByTagName('item')[0];
    if (!itemEl) return null;

    const weaponName = itemEl.getAttribute('name') || 'unknown_weapon';
    const category = itemEl.getAttribute('category') || 'unknown_category';

    // Ищем ammo_type (<param name="ammo_type" value="..."/>)
    let ammoType = '';
    const fireparams = itemEl.getElementsByTagName('fireparams');
    if (fireparams.length > 0) {
      const fire = fireparams[0].getElementsByTagName('fire');
      if (fire.length > 0) {
        const paramList = fire[0].getElementsByTagName('param');
        for (let i = 0; i < paramList.length; i++) {
          const p = paramList[i];
          const pName = p.getAttribute('name');
          if (pName === 'ammo_type') {
            ammoType = p.getAttribute('value') || '';
          }
        }
      }
    }

    // Скины (<skins><material name="..."/>)
    let skins = [];
    const skinsEls = itemEl.getElementsByTagName('skins');
    if (skinsEls.length > 0) {
      const matEls = skinsEls[0].getElementsByTagName('material');
      for (let i = 0; i < matEls.length; i++) {
        const nameAttr = matEls[i].getAttribute('name');
        if (nameAttr) {
          skins.push(nameAttr);
        }
      }
    }

    // Модули (attachments) — <sockets><socket><support name="...">
    let attachments = [];
    const socketsEls = itemEl.getElementsByTagName('sockets');
    if (socketsEls.length > 0) {
      const socketList = socketsEls[0].getElementsByTagName('socket');
      for (let i = 0; i < socketList.length; i++) {
        const supList = socketList[i].getElementsByTagName('support');
        for (let j = 0; j < supList.length; j++) {
          const supName = supList[j].getAttribute('name');
          if (supName) {
            attachments.push(supName);
          }
        }
      }
    }

    return {
      name: weaponName,
      category,
      ammoType,
      skins,
      attachments
    };
  } catch (err) {
    console.error('Error in parseWeaponXML:', err);
    return null;
  }
}

/*************************************************************
 * 4) Загрузка и парсинг ВСЕХ skin-XML из skins_manifest.json
 *************************************************************/
async function loadAllSkins(manifestPath) {
  const result = [];

  try {
    const manifestRes = await fetch(manifestPath);
    const manifestList = await manifestRes.json();

    for (const xmlFilePath of manifestList) {
      const skinObj = await parseSkinXML(xmlFilePath);
      if (skinObj) {
        result.push(skinObj);
      }
    }
  } catch (err) {
    console.error('Error loading skins:', err);
  }

  return result;
}

/*************************************************************
 * parseSkinXML
 *************************************************************/
async function parseSkinXML(xmlFilePath) {
  try {
    const res = await fetch(xmlFilePath);
    const xmlText = await res.text();

    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

    // Предположим, что там <GameItem name="..."/>
    const gameItemEl = xmlDoc.getElementsByTagName('GameItem')[0];
    if (!gameItemEl) return null;

    const skinName = gameItemEl.getAttribute('name') || 'unknown_skin';

    return {
      name: skinName
      // по желанию - ещё какие-то поля
    };
  } catch (err) {
    console.error('Error in parseSkinXML:', err);
    return null;
  }
}

/*************************************************************
 * 5) populateAppearanceSelect
 *************************************************************/
function populateAppearanceSelect() {
  const select = document.getElementById('appearanceSelect');
  select.innerHTML = '';

  // Опция «Без внешности»
  const noneOption = document.createElement('option');
  noneOption.value = '';
  noneOption.textContent = 'Без внешности';
  select.appendChild(noneOption);

  skinsData.forEach(sk => {
    const opt = document.createElement('option');
    opt.value = sk.name; // originalName
    // Попробуем дать локализованное имя, если есть
    const localized = localizationMap[sk.name] || sk.name;
    opt.textContent = localized;
    select.appendChild(opt);
  });

  // По умолчанию нет внешности
  selectedAppearance = '';
  select.value = selectedAppearance;

  // Событие выбора
  select.addEventListener('change', () => {
    selectedAppearance = select.value;
  });
}

/*************************************************************
 * 6) Поиск «на лету»
 *************************************************************/
document.getElementById('searchInput').addEventListener('input', () => {
  const query = document.getElementById('searchInput').value.toLowerCase();
  filteredWeapons = weaponsData.filter(w => {
    const locName = localizationMap[w.name] || w.name;
    return (
      locName.toLowerCase().includes(query) ||
      w.name.toLowerCase().includes(query)
    );
  });
  currentPage = 1;
  renderWeaponList();
});

/*************************************************************
 * 7) Рендер списка оружия (с пагинацией)
 *************************************************************/
function renderWeaponList() {
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const itemsToShow = filteredWeapons.slice(startIndex, endIndex);

  const ul = document.getElementById('weaponsUl');
  ul.innerHTML = '';

  itemsToShow.forEach(w => {
    const li = document.createElement('li');
    const locName = localizationMap[w.name] || w.name;
    li.textContent = `${locName} (${w.name})`;
    li.onclick = () => addSelectedWeapon(w);
    ul.appendChild(li);
  });

  const pageInfo = document.getElementById('pageInfo');
  const totalPages = Math.ceil(filteredWeapons.length / itemsPerPage);
  pageInfo.textContent = `Стр. ${currentPage} из ${totalPages}`;
}

// Кнопки «предыдущая / следующая страница»
document.getElementById('prevPageBtn').addEventListener('click', () => {
  if (currentPage > 1) {
    currentPage--;
    renderWeaponList();
  }
});
document.getElementById('nextPageBtn').addEventListener('click', () => {
  const totalPages = Math.ceil(filteredWeapons.length / itemsPerPage);
  if (currentPage < totalPages) {
    currentPage++;
    renderWeaponList();
  }
});

/*************************************************************
 * 8) Добавить предмет в выбранные
 *************************************************************/
function addSelectedWeapon(w) {
  // Если не хотите дубликаты, проверяем:
  /*
  const already = selectedWeapons.find(x => x.name === w.name);
  if (already) return;
  */

  // Превратим "bare" weapon в объект, где есть place for selectedSkinId
  const newItem = {
    originalName: w.name,
    localizedName: localizationMap[w.name] || w.name,
    ammoType: w.ammoType,
    attachments: (w.attachments || []).map(attId => ({
      id: attId,
      localizedName: localizationMap[attId] || attId
    })),
    skins: (w.skins || []).map(sId => ({
      id: sId,
      localizedName: localizationMap[sId] || sId
    })),
    selectedSkinId: ""
  };

  selectedWeapons.push(newItem);
  renderSelectedWeapons();
}

/*************************************************************
 * 9) Отрисовать выбранные предметы
 *************************************************************/
function renderSelectedWeapons() {
  const container = document.getElementById('selectedContainer');
  container.innerHTML = '';

  selectedWeapons.forEach((sw, index) => {
    const div = document.createElement('div');
    div.className = 'selectedWeaponItem';

    // Название
    const title = document.createElement('div');
    title.innerHTML = `<strong>${sw.localizedName}</strong>`;
    div.appendChild(title);

    // Выбор скина (если есть)
    if (sw.skins.length > 0) {
      const skinLabel = document.createElement('label');
      skinLabel.textContent = 'Скин: ';
      const skinSelect = document.createElement('select');

      // Опция «Без скина»
      const defOpt = document.createElement('option');
      defOpt.value = '';
      defOpt.textContent = 'Без скина';
      skinSelect.appendChild(defOpt);

      sw.skins.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.localizedName;
        skinSelect.appendChild(opt);
      });

      skinSelect.value = sw.selectedSkinId;
      skinSelect.onchange = (e) => {
        sw.selectedSkinId = e.target.value;
      };
      skinLabel.appendChild(skinSelect);
      div.appendChild(skinLabel);
    }

    // Кнопка «Удалить»
    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Удалить';
    removeBtn.style.marginLeft = '16px';
    removeBtn.onclick = () => {
      selectedWeapons.splice(index, 1);
      renderSelectedWeapons();
    };
    div.appendChild(removeBtn);

    container.appendChild(div);
  });
}

/*************************************************************
 * 10) Сгенерировать Lua-пресет
 *************************************************************/
document.getElementById('generateBtn').addEventListener('click', () => {
  const preset = generatePresetLua();
  document.getElementById('resultArea').value = preset;
});

function generatePresetLua() {
  // Внешность
  const appearanceLine = selectedAppearance
    ? `{name = "${selectedAppearance}"},`
    : '';

  // armor
  const armorBlock = `
  armor =
  {
    ${appearanceLine}
  },`;

  // items
  let itemsStr = `  items = {\n`;
  selectedWeapons.forEach(sw => {
    itemsStr += `    { name = "${sw.originalName}", skin = "${sw.selectedSkinId}" },\n`;
  });
  itemsStr += `  },`;

  // attachments
  let attachmentsStr = `  attachments = {\n`;
  selectedWeapons.forEach(sw => {
    (sw.attachments || []).forEach(att => {
      attachmentsStr += `    { name = "${att.id}", attachTo = "${sw.originalName}" },\n`;
    });
  });
  attachmentsStr += `  },`;

  // ammo
  let ammoStr = `  ammo = {\n`;
  selectedWeapons.forEach(sw => {
    if (sw.ammoType) {
      ammoStr += `    { name = "${sw.ammoType}", amount = 999 },\n`;
    }
  });
  ammoStr += `  },`;

  const luaScript = `
local inventory = {
${armorBlock}
${itemsStr}
${attachmentsStr}
${ammoStr}
}
return inventory
`.trim();

  return luaScript;
}

/*************************************************************
 * 11) «Скачать» полученный Lua-текст
 *************************************************************/
document.getElementById('downloadBtn').addEventListener('click', () => {
  const text = document.getElementById('resultArea').value;
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);

  const link = document.createElement('a');
  link.href = url;
  link.download = 'warface_preset.lua';
  link.click();

  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
